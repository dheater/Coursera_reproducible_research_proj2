```{r, cache=TRUE, echo=TRUE}
```
Your document should have a title that briefly summarizes your data analysis
===================


## Synopsis

At most, 10 complete sentences that summarize the results.


## Data Processing

Obtain the NOAA storm data from the course website.

```{r read data}
fname="./stormdata.bz2"
if(!file.exists(fname)) {
    url <- "http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
    download.file(url, fname, mode="wb")
}
stormdata=read.csv(fname)
```

We don't need all of the data to answer the questions. Because the older data is less consistent in the way it was collected, and is likely, less accurate. The number of entries neary doubled in 1994, to over 20000 entries per year. This seems to reflect a change in collection. Therefore we will subset the data to include data from 1989 onward.

```{r subset dates}
stormdata$DATE=as.Date(factor(stormdata$BGN_DATE), format("%m/%d/%Y"))
stormdata$YEAR=as.numeric(format(stormdata$DATE, "%Y"))
stormdata=subset(stormdata,YEAR>=1994)
```

The data obtained contains values for U.S. States and territories, but also data from sources that are unclear. For the purposes of this analysis, we will limit the scope to only the 50 states and the District of Columbia.

```{r subset states}
statelist=c("AK","AL","AR","AZ","CA","CO","CT","DC","DE","FL","GA","HI","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WA","WI","WV","WY")
statedata=subset(stormdata, STATE %in% statelist)
statedata=droplevels(statedata)
```

The naming conventions are inconsistent. We try to make a reasonable attempt to group similary named events.

```{r group by event type}
statedata$EVTYPE=with(statedata, gsub(".*UNSEASONABL.*|WARM WEATHER|UNUSUALLY WARM|VERY WARM|PROLONG WARMTH|MONTHLY PRECIPITATION","UNSEASONABLE WEATHER", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub(".*WINTER.*|.*SNOW.*|.*BLIZZARD.*|.*ICE.*|.*FROST.*|.*FREEZE.*|.*COLD.*|.*WINTRY.*|.*FREEZING.*|.*ICY.*","WINTER WEATHER", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub(".*SLEET.*","SLEET", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub(".*HEAT.*|EXTREME HEAT|RECORD WARMTH","EXTREME HEAT", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub(".*THUNDERSTORM.*","THUNDERSTORM", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub(".*WILD ?FIRE|.*BRUSH ?FIRE|.*FOREST ?FIRE","WILD/FOREST FIRE", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub("ABNORMALLY WET|EXTREMELY WET","WET CONDITIONS", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub("LAND ?SLIDE|LANDSLUMP|MUD ?SLIDE","LANDSLIDE", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub(".*.*DROUGHT.*.*|ABNORMALLY DROUGHT|VERY DRY.*|DRY|DRY SPELL|DRY CONDITIONS","DROUGHT", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub(".*HAIL.*","HAIL", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub(".*TORNADO.*|.*FUNNEL.*|.*WATERSPOUT.*","TORNADO", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub(".*HURRICANE.*","HURRICANE", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub(".*FLOOD.*|.*RAIN.*|STORM SURGE|.*STREAM FLD|.*HIGH WATER.*","FLOODING", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub(".*SURF.*|.*RED FLAG.*","HIGH/HAZARDOUS SURF", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub(".*WIND.*|.*WND.*","HIGH WIND", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub(".*DUST.*","DUST STORM", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub(".*FOG.*","FOG", EVTYPE, ignore.case=T))

statedata$EVTYPE=with(statedata, gsub("*.RIP CURRENT.*","RIP CURRENT", EVTYPE, ignore.case=T))

# Turn the event types back into factor variables.
statedata$EVTYPE=factor(statedata$EVTYPE)

unique(statedata$EVTYPE)
```

To assess the most harmful severe weather events we will look at events that have a number of high numbers of fatalities and high number of injuries.

```{r assess harmfulness}
fatalities=with(statedata, aggregate(FATALITIES, by=list(EVTYPE), FUN=sum))
# Drop rows with zero values.
fatalities=subset(fatalities, x > 0)
fatalities=droplevels(fatalities)
#fatalities$Group.1=factor(fatalities$Group.1)

hi.fatal=subset(fatalities, x > 500)
hi.fatal=droplevels(hi.fatal)
hi.fatal

injuries=with(statedata, aggregate(INJURIES, by=list(EVTYPE), FUN=sum))
# Drop rows with zero values.
injuries=subset(injuries, x > 0)
injuries=droplevels(injuries)

hi.injury=subset(injuries, x > 2500)
hi.injury=droplevels(hi.injury)
hi.injury
```

```{r assess economic impact}
statedata$PROPDMGEXP=sub("K","1000", statedata$PROPDMGEXP, ignore.case=T)
statedata$PROPDMGEXP=sub("M","1000000", statedata$PROPDMGEXP, ignore.case=T)
statedata$PROPDMGEXP=sub("B","1000000000", statedata$PROPDMGEXP, ignore.case=T)
statedata$PROPDMGEXP=sub("[^KMB]","1",statedata$PROPDMGEXP, ignore.case=T)
statedata$PROPDMGEXP=as.numeric(statedata$PROPDMGEXP)
statedata$PROPDMGEXP[is.na(statedata$PROPDMGEXP)]=1
table(statedata$PROPDMGEXP)

statedata$CROPDMGEXP=sub("K","1000", statedata$CROPDMGEXP, ignore.case=T)
statedata$CROPDMGEXP=sub("M","1000000", statedata$CROPDMGEXP, ignore.case=T)
statedata$CROPDMGEXP=sub("B","1000000000", statedata$CROPDMGEXP, ignore.case=T)
statedata$CROPDMGEXP=sub("[^KMB]","1",statedata$CROPDMGEXP, ignore.case=T)
statedata$CROPDMGEXP=as.numeric(statedata$CROPDMGEXP)
statedata$CROPDMGEXP[is.na(statedata$CROPDMGEXP)]=1
table(statedata$CROPDMGEXP)

statedata$COST = with(statedata, PROPDMG*PROPDMGEXP + CROPDMG*CROPDMGEXP)
```


## Results

To assess the most harmful severe weather events we will look at events that have a number of high numbers of fatalities and high number of injuries.

```{r plot harmfulness}
par(mar=c(10.1,5.1,4.1,2.1))
par(oma=c(5,3,5))
plot(hi.fatal, las=2, main="Number of fatalities per severe weather type", xlab="", ylab="Number of Fatalities")
plot(hi.injury, las=2, main="Number of injuries per severe weather type", xlab="", ylab="Number of Injuries")
```



```{r}
```

